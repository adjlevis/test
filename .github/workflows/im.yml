name: OneCloud Immortalwrt Auto Build

on:
  workflow_dispatch:
  schedule:
    - cron: '0 19 * * *'  # UTC 19:00 = åŒ—äº¬æ—¶é—´ 03:00 è‡ªåŠ¨æ„å»º

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§¹ Clean old release folder
        run: |
          rm -rf release || true
          mkdir -p release

      - name: âš™ï¸ Prepare environment
        run: |
          chmod +x docker-build.sh build.sh
          mkdir -p bin files
          sudo chmod -R 777 bin files

      - name: ğŸ‹ Pull ImmortalWrt ImageBuilder
        run: docker pull immortalwrt/imagebuilder:armsr-armv7-openwrt-24.10

      - name: ğŸ—ï¸ Build firmware
        run: ./docker-build.sh

      - name: ğŸ•’ Get Beijing Time
        id: time
        run: |
          export TZ=Asia/Shanghai
          echo "datetime=$(date '+%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
          echo "datetime_readable=$(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_OUTPUT

      - name: ğŸ“ List built files
        id: list_files
        run: |
          {
            echo 'files<<EOF'
            ls -1 | grep -E 'onecloud-.*\.img\.xz' || echo "æ— å›ºä»¶æ–‡ä»¶"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: ğŸš€ Publish to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: Onecloud-Immortalwrt-${{ steps.time.outputs.datetime }}
          name: "OneCloud ImmortalWrt å›ºä»¶è‡ªåŠ¨æ„å»º"
          body: |
            âœ… OneCloud å›ºä»¶æ„å»ºå®Œæˆï¼
            
            - æ„å»ºæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼š${{ steps.time.outputs.datetime_readable }}
            - æ„å»ºç¼–å·ï¼š${{ github.run_number }}
            
            æœ¬æ¬¡æ›´æ–°å†…å®¹ï¼š
            ```
            $(cat release_note/update.txt)
            ```

            ğŸ’¾ å›ºä»¶æ–‡ä»¶ï¼š
            ${{ steps.list_files.outputs.files }}
          files: onecloud-immortalwrt-ext4-emmc-burn.img.xz
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ§½ Clean old releases (keep latest 1)
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          repo: ${{ github.repository }}
          keep_latest: 1
          delete_tag_pattern: "Onecloud-Immortalwrt-*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

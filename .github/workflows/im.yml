name: Onecloud Immortalwrt Build

on:
  workflow_dispatch:
  schedule:
    - cron: '0 19 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´ 03:00 è‡ªåŠ¨æ„å»º

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: immortalwrt

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare build environment
        run: |
          sed -i 's/\r$//' build.sh docker-build.sh || true
          chmod +x build.sh docker-build.sh
          mkdir -p bin files
          sudo chmod -R 777 bin files

      - name: Build firmware
        run: ./docker-build.sh

      - name: Get Beijing Time
        id: time
        run: |
          export TZ=Asia/Shanghai
          echo "datetime=$(date '+%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
          echo "datetime_readable=$(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_OUTPUT

      - name: Find firmware
        id: find_file
        run: |
          FILE_PATH=$(find bin/targets -type f -name "onecloud-immortalwrt-ext4-emmc-burn.img.xz" | head -n 1)
          echo "file_path=$FILE_PATH" >> $GITHUB_OUTPUT
          if [ -z "$FILE_PATH" ]; then
            echo "âŒ æ²¡æ‰¾åˆ° onecloud-immortalwrt-ext4-emmc-burn.img.xz"
            exit 1
          fi

      - name: Archive source code
        run: |
          cd ..
          tar -czf immortalwrt-source-${{ steps.time.outputs.datetime }}.tar.gz immortalwrt

      - name: Publish to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: Onecloud-Immortalwrt-${{ steps.time.outputs.datetime }}
          name: "Onecloud Immortalwrt æ›´æ–°ç‰ˆ"
          body: |
            âœ… Onecloud Immortalwrt è‡ªåŠ¨æ„å»ºå®Œæˆï¼
            - å†…æ ¸ç‰ˆæœ¬ï¼š24.10
            - å‘å¸ƒæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼š${{ steps.time.outputs.datetime_readable }}
            ğŸ“¦ æ–‡ä»¶è¯´æ˜ï¼š
            - onecloud-immortalwrt-ext4-emmc-burn.img.xz ï¼šçº¿åˆ·åŒ…
            - immortalwrt-source-${{ steps.time.outputs.datetime }}.tar.gz ï¼šæºç å½’æ¡£
          files: |
            ${{ steps.find_file.outputs.file_path }}
            ../immortalwrt-source-${{ steps.time.outputs.datetime }}.tar.gz
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete older releases
        if: github.ref == 'refs/heads/main'
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          repo: ${{ github.repository }}
          keep_latest: 1
          delete_tag_pattern: "Onecloud-Immortalwrt-*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Onecloud Immortalwrt Build

on:
  workflow_dispatch:
  schedule:
    - cron: '0 19 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´ 03:00 è‡ªåŠ¨æ„å»º

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: immortalwrt

    steps:
      # 1ï¸âƒ£ æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ å‡†å¤‡ç¯å¢ƒ
      - name: Prepare build environment
        run: |
          sed -i 's/\r$//' build.sh docker-build.sh || true
          chmod +x build.sh docker-build.sh
          mkdir -p bin files
          sudo chmod -R 777 bin files

      # 3ï¸âƒ£ æ‹‰å–é•œåƒæ„å»º
      - name: Pull ImmortalWrt ImageBuilder
        run: docker pull immortalwrt/imagebuilder:armsr-armv7-openwrt-24.10

      # 4ï¸âƒ£ ç¼–è¯‘å›ºä»¶
      - name: Build firmware
        run: ./docker-build.sh

      # 5ï¸âƒ£ è·å–åŒ—äº¬æ—¶é—´
      - name: Get Beijing Time
        id: time
        run: |
          export TZ=Asia/Shanghai
          echo "datetime=$(date '+%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
          echo "datetime_readable=$(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_OUTPUT

      # 6ï¸âƒ£ æŸ¥æ‰¾ç›®æ ‡å›ºä»¶æ–‡ä»¶ï¼ˆçº¿åˆ·åŒ…ï¼‰
      - name: Find firmware
        id: find_file
        run: |
          FILE_PATH=$(find bin/targets -type f -name "onecloud-immortalwrt-ext4-emmc-burn.img.xz" | head -n 1)
          echo "file_path=$FILE_PATH" >> $GITHUB_OUTPUT
          if [ -z "$FILE_PATH" ]; then
            echo "âŒ æ²¡æ‰¾åˆ° onecloud-immortalwrt-ext4-emmc-burn.img.xz"
            exit 1
          fi

      # 7ï¸âƒ£ å‹ç¼©æºç å½’æ¡£
      - name: Archive source code
        run: |
          cd ..
          tar -czf immortalwrt-source-${{ steps.time.outputs.datetime }}.tar.gz immortalwrt

      # 8ï¸âƒ£ åˆ›å»º Release
      - name: Publish to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: Onecloud-Immortalwrt-${{ steps.time.outputs.datetime }}
          name: "Onecloud Immortalwrt æ›´æ–°ç‰ˆ"
          body: |
            âœ… Onecloud Immortalwrt è‡ªåŠ¨æ„å»ºå®Œæˆï¼

            - å†…æ ¸ç‰ˆæœ¬ï¼š24.10
            - å‘å¸ƒæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼š${{ steps.time.outputs.datetime_readable }}

            ğŸ“¦ æœ¬æ¬¡æ›´æ–°å†…å®¹ï¼š
            - æ–°å¢åŠŸèƒ½æˆ–æ’ä»¶è¯·åœ¨æ„å»ºè„šæœ¬ä¸­æè¿°ï¼ˆbuild.shï¼‰
            - é»˜è®¤ç™»å½•å¯†ç ï¼šç©ºå¯†ç ï¼ˆroot ç›´æ¥å›è½¦ï¼‰
            - ä»…æä¾›çº¿åˆ·åŒ… + æºç å‹ç¼©åŒ…

            ğŸ’¾ æ–‡ä»¶è¯´æ˜ï¼š
            - onecloud-immortalwrt-ext4-emmc-burn.img.xz ï¼šçº¿åˆ·åŒ…
            - immortalwrt-source-${{ steps.time.outputs.datetime }}.tar.gz ï¼šæºç å½’æ¡£
          files: |
            ${{ steps.find_file.outputs.file_path }}
            ../immortalwrt-source-${{ steps.time.outputs.datetime }}.tar.gz
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 9ï¸âƒ£ ä»…ä¿ç•™æœ€æ–° 1 ä¸ª Release
      - name: Delete older releases
        if: github.ref == 'refs/heads/main'
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          repo: ${{ github.repository }}
          keep_latest: 1
          delete_tag_pattern: "Onecloud-Immortalwrt-*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
